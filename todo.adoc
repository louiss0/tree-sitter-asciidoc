= TODO

== Context

All whitespace experiments have been rolled back per user request, so `plain_text`, `_inline_unit`, and `_inline_text` now match the older grammar. This restores the previous behavior where inline math/index-term macros win over `plain_text`; `test/corpus/30_math_macros.txt` (and suites 25–26) pass cleanly again. The downside is that the newer corpus expectations (suites 02–15) no longer match the parser output: `_inline_space` is once again an `_inline_unit`, so blank lines and directive prefixes are swallowed as paragraph content instead of delimiting blocks. Highlight snapshots are still out-of-date, but we are deferring them until the corpus stabilizes.

== Immediate Next Steps

. **Fix inline whitespace so block boundaries survive**
* *Failing suites:* `02_paragraphs`, `03_attributes`, `04_hierarchy`, `05_edge_cases`, every list suite (`06`–`10`), conditionals (`11`–`13`), and the anchors/footnotes suite (`15`). They all expect multiple `inline_seq_nonempty` nodes per paragraph, but the reverted grammar collapses each paragraph into a single inline sequence because `_inline_space` appears in `_inline_unit`.
* *Root cause:* When `_inline_space` is a standalone inline unit, blank lines never get tokenized as `_blank_line`, so paragraphs absorb intervening lines, list markers, and `ifdef`-like words. The tests were previously updated to the “new” behavior where whitespace lives inside `plain_text`, so rolling back puts the parser out of sync.
* *Proposed fix:*
** Introduce an `_inline_gap` token defined as `token.immediate(/[ \t]+/)` and consume it only *between* inline units (never at the start of a paragraph). Keep `_inline_gap` out of `_block_element`, so blank lines still win column-0 races.
** Extract `_inline_core_unit` (inline elements, escaped chars, `plain_text`, `formatting_fallback`), then define `inline_seq_nonempty` as `seq($._inline_core_unit, repeat(seq(optional($._inline_gap), $._inline_core_unit)))`.
** Within `plain_text`, stitch `_plain_text_segment` together using an internal `_inline_text_space` token so visible spaces remain part of the same token. This keeps prose readable while preventing `_inline_space` from appearing as its own AST node.
** After implementing, regenerate the parser and re-run `npx tree-sitter test` for suites 02–15 plus spot-check math/index-term suites to ensure no regressions.

. **Keep math/index-term suites green**
* Math tests (`test/corpus/30_math_macros.txt`) and index-term files (`25`, `26`) pass with the reverted grammar. Re-run them after any whitespace change to be sure the new approach does not consume macro prefixes before their tokens fire.

. **Scanner/highlight backlog**
* Once whitespace is stable, resume the scanner audit (CRLF fence handling, `DELIMITED_BLOCK_CONTENT_LINE` EOF behavior, attribute lists after paragraphs). No scanner changes were made during this session.
* Highlight snapshots remain stale; run the PowerShell script from `AGENTS.md` only after the corpus is green and the user approves refreshing expectations.

. **Generated artifacts policy**
* `npx tree-sitter generate` has already been run for the rollback. Per AGENTS instructions, delete and regenerate the `src/` artifacts again once both corpus and highlight suites pass.

== Session Summary (current session)

* Reverted all inline whitespace experiments so the grammar matches its pre-experiment state, then regenerated `src/grammar.json`, `src/node-types.json`, and `src/parser.c`.
* Verified that math macros (suite 30) and index-term cases (25–26) still pass—math regressions are resolved.
* Ran `npx tree-sitter test --overview-only` and confirmed that suites 02–15 now fail because their fixtures reflect the newer inline spacing model (multiple `inline_seq_nonempty` nodes per paragraph). The failures manifest as entire sections/lists parsing as paragraphs with duplicated inline sequences.

== Follow-ups / Questions for User

* Confirm whether the `_inline_gap` approach (whitespace handled via `token.immediate` between inline units) aligns with expectations before the next implementation attempt.
* Let me know when it’s acceptable to resume `pass_macro` work and to refresh highlight snapshots once the corpus suite is back to green.
