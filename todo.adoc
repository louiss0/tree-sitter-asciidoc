= TODO

== Context

Grammar and parser sources were rolled back to the last known-good state after the inline/metadata experiments, leaving only corpus updates in place. While that reset stabilized most suites, attribute-related tests are now failing again in downstream branches (the failure reproduces intermittently depending on cached parser artifacts).

Current symptoms:

* Attribute entries that include stray spaces around the key/colon (e.g., `: attr:`) are being tokenized as paragraphs instead of `attribute_entry` nodes.
* Dangling `{attr}` references inside inline styles sometimes split into separate `plain_text` nodes, which causes `03_attributes`, `19_inline_formatting`, and `22_macros_roles` to flip between pass/fail.
* Our external scanner still short-circuits `:` at column 0 into `PLAIN_COLON`, so attribute lines beginning with whitespace can never become attributes even if the colon alignment is correct.

== Immediate Next Tasks

1. **Reproduce and capture the attribute failures**
   * Run `npx tree-sitter test --file-name 03_attributes.txt --show-fields` plus the attribute sections of suites 19 and 22 while toggling a `tree-sitter generate` to ensure the parser artifacts match the current grammar.
   * Save the diffs from `tree-sitter test --update` (but do not check them in) so we can compare the parser’s tree against our intended AST.

2. **Retool the attribute tokens**
   * Reintroduce a grammar-level token for attribute names that tolerates optional whitespace before/after the colon while still matching `:name:` exactly; reuse the `_attribute_name_text` helper so we avoid duplicated regexes.
   * Adjust the external scanner so `PLAIN_COLON` only triggers when the colon is isolated (e.g., a loose `:` at column 0). When the lexer sees `:` followed immediately by a valid attribute name pattern, emit the dedicated attribute token instead.
   * Ensure malformed lines (extra spaces or missing closing colon) fall back to `paragraph` content instead of producing `ERROR` nodes.

3. **Restore attribute-reference stability**
   * Keep `{attr}` parsing strict, but when braces do not balance (`} foo` or ` {name`), force them into `_plain_text_segment` so inline styles around them continue parsing.
   * Update the corpus cases under `23_inline_edge_cases` to cover these permutations once the grammar produces stable output again.

4. **Verification**
   * Regenerate the parser (`npx tree-sitter generate`) and rerun `npx tree-sitter test` across all suites, focusing on 03, 19, 22, and 23 first.
   * If any grammar node names changed, refresh the highlight snapshots via the PowerShell runner and delete `test/highlight/.actual` afterward.

== Notes for Next Agent

* Keep following `AGENTS.md`: no lookahead/grouped regexes, no edits under `bindings/`, keep `source_file` first, and model adjacency via the scanner when necessary.
* Math macros must stay as generic `inline_macro` nodes; we already aligned the corpora accordingly.
* Plenty of highlight snapshots are dirty locally—do not revert them. Only rerun the highlight suite when grammar behavior changes in a way that affects captures.

== Open Questions

1. Should attribute entries that start with a tab or spaces still be considered valid, or must the colon begin in column 0 per AsciiDoc spec?
2. Do we need to capture malformed `{attr}` references explicitly (e.g., a dedicated `attribute_substitution_error` node), or is falling back to plain text sufficient?

== Verification Checklist

* `npx tree-sitter generate`
* `npx tree-sitter test --file-name 03_attributes.txt`
* `npx tree-sitter test --file-name 19_inline_formatting.txt --include "Attribute references"`
* `npx tree-sitter test --file-name 22_macros_roles.txt --include "Attribute references"`
* Full `npx tree-sitter test` sweep before requesting review
* Highlight runner (PowerShell script in `AGENTS.md`) if node names/fields change
