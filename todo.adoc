= TODO

== Context

Inline macro handling is now correct, but highlight tests are all failing because whitespace was moved back into `extras`:

* `src/scanner.c` emits `INLINE_MACRO_MARKER` / `BLOCK_MACRO_MARKER` only when a `[` appears before a newline after `:`/`::`, otherwise it returns `PLAIN_COLON`. This prevents inline/block macros from degenerating into `plain_text`.
* `grammar.js` treats inline and block macros as `macro_name` + marker + optional `macro_body` (line 1062+). `_inline_core_unit` includes `plain_text` and `plain_colon`, and whitespace (spaces/tabs) now lives solely in `extras`.
* Because spaces are no longer part of `plain_text`, every highlight snapshot under `test/highlight/expected/` is stale. The PowerShell highlight runner from `AGENTS.md` was executed and reported mismatches for every case (`attributes`, `macros`, `lists`, etc.). `.actual` files have the new captures for reference.

No corpus suites were run in this session per the user’s “run highlight tests” request. Working tree contains regenerated parser outputs plus scratch files (`debug.log`, `tmp_sample.adoc`, `tmp_text.adoc`).

== Immediate Next Tasks

1. **Resolve highlight failures**
   * Decide with the user whether to refresh `test/highlight/expected/*.captures` to match the new whitespace behavior (preferred) or revert the whitespace change (keep spaces inside `plain_text`). The current instructions lean toward keeping whitespace in `extras`, so expect to regenerate snapshots.
   * To refresh: rerun the PowerShell highlight command from `AGENTS.md`, then copy each file from `test/highlight/.actual/` into `test/highlight/expected/` (permitted step in the script). Re-run the test to confirm it prints “All highlight tests passed.” Remember to remove `.actual` afterward.

2. **Clean workspace**
   * Delete `debug.log`, `tmp_sample.adoc`, and `tmp_text.adoc` unless the user wants to keep them. These were temporary parsing fixtures.
   * Ensure no other generated directories remain (only `src/` artifacts should be present after `tree-sitter generate`).

3. **Plan block-macro validation**
   * Block macros share the scanner path but currently lack dedicated tests. After highlight expectations are updated, request permission to add corpus/highlight cases for block macros (e.g., `image::path[]`, `include::file[]`) so regressions surface automatically.

4. **Future parser verification**
   * Once highlights are green, run `npx tree-sitter test` (with approval) to see if any corpus suites broke due to the whitespace shift. The user suspects plain-text parsing may still need tweaks.
   * If failures appear, inspect the suites involving lists, conditionals, or description lists since they rely heavily on colon tokens that now use the scanner fallback.

== Notes for Next Agent

* Do not touch `bindings/`. Follow `AGENTS.md` for grammar constraints (no lookahead regex, no duplicate regex per node, keep `source_file` first).
* Before writing new tests, ask the user for approval. When highlight expectations change, update both the snapshots and (if necessary) `queries/highlights.scm`.
* Keep the macro scanner’s single-token policy: once a colon is classified, emit exactly one token (`INLINE_MACRO_MARKER`, `BLOCK_MACRO_MARKER`, or `PLAIN_COLON`).
* After resolving highlights, regenerate parser outputs (`npx tree-sitter generate`) and delete any `.actual` folders the highlight runner created.

== Open Questions for the User

1. Should we refresh the highlight snapshots now that whitespace lives in `extras`, or revert the whitespace change to keep legacy captures?
2. Is it okay to remove the temporary files (`debug.log`, `tmp_sample.adoc`, `tmp_text.adoc`) before the next commit?
3. When can we add formal tests for block macros?

== Verification Checklist

* Highlight suite (`pwsh -NoLogo -NoProfile -Command …`) – must pass cleanly.
* `npx tree-sitter parse test/highlight/cases/macros.adoc` – confirm inline macros still parse into `inline_macro` nodes.
* Remove `test/highlight/.actual` after successful runs.
